<?xml version="1.0" encoding="UTF-8"?>

<database name="diplomacy" defaultIdMethod="native" namespace="DiplomacyOrm">

	<table name="game">
		<column name="game_id" type="integer" required="true" primaryKey="true" autoIncrement="true" />
		<column name="name" type="varchar" size="150" required="true" />
		<column name="start_year" type="integer" required="true" />
		<column name="start_season" type="ENUM" valueSet="spring,fall" default="spring" />
	</table>

	<table name="empire">
		<column name="game_id" type="integer" required="true" />
		<column name="empire_id" type="integer" required="true" primaryKey="true" autoIncrement="true" />
		<column name="abbr" type="varchar" required="true" size="10" description="Abbreviated name.  Would often be used as an ID on paper, or in the spreadsheet" />
		<column name="name_official" phpName="name" type="varchar" size="100" required="true" />
		<column name="name_long" type="varchar" size="100" required="true" />
		<column name="name_short" type="varchar" size="10" required="true" />

		<foreign-key foreignTable="game" onDelete="CASCADE">
			<reference local="game_id" foreign="game_id" />
		</foreign-key>
	</table>

	<table name="game_match" phpName="Match">
		<column name="game_id" type="integer" />
		<column name="match_id" type="integer" primaryKey="true" autoIncrement="true" />
		<column name="name" type="varchar" size="150" required="true" />
		<column name="created_on" type="timestamp" />
		<column name="updated_at" type="timestamp" />

		<foreign-key foreignTable="game" onDelete="CASCADE">
			<reference local="game_id" foreign="game_id" />
		</foreign-key>

		<behavior name="timestampable">
			<parameter name="create_column" value="created_on" />
			<parameter name="update_column" value="updated_at" />
		</behavior>
	</table>

	<table name="turn">
		<column name="match_id" type="integer" />
		<column name="turn_id" type="integer" primaryKey="true" autoIncrement="true" />

		<column name="name" type="varchar" size="150" required="true" description="Name of the game instance" />
		<column name="step" type="integer" required="true" default="0" />

		<column name="state" type="enum" valueSet="open,require_retreats,complete" default="open" />

		<column name="created_on" type="timestamp" />
		<column name="updated_at" type="timestamp" />

		<column name="transcript" type="longvarchar" required="false" description="Full transcript of the orders that are executed in this turn" />

		<foreign-key foreignTable="game_match" refPhpName="MatchTurn" onDelete="CASCADE">
			<reference local="match_id" foreign="match_id" />
		</foreign-key>

		<behavior name="timestampable">
			<parameter name="create_column" value="created_on" />
			<parameter name="update_column" value="updated_at" />
		</behavior>
	</table>

	<table name="empire_order" phpName="Order" abstract="false" description="Saves the orders of each turn.  Required because there is a break in the process between initial orders and required retreats.">
		<column name="order_id" type="integer"  required="true" primaryKey="true" autoIncrement="true" />
		<column name="turn_id"  type="integer"  required="true" />
		<column name="empire_id" type="integer" required="true" />
		<column name="unit" type="enum" valueSet="army,fleet" description="Occupying unit." />
		<column name="command" type="varchar" size="100" required="true" description="Full order/command text." />
		<column name="status" type="enum" valueSet="succeeded,failed" default="succeeded" />
		<column name="transcript" type="longvarchar" description="Transcript of this order" />
		<column name="source_id" type="integer" description="Source territory of order" />
		<foreign-key foreignTable="turn" onDelete="CASCADE">
			<reference local="turn_id" foreign="turn_id" />
		</foreign-key>
		<foreign-key foreignTable="empire" onDelete="CASCADE">
			<reference local="empire_id" foreign="empire_id" />
		</foreign-key>
		<foreign-key foreignTable="match_state" phpName="Source" onDelete="CASCADE">
			<reference local="source_id" foreign="state_id" />
		</foreign-key>
	</table>

	<table name="order_move" phpName="Move">
		<behavior name="concrete_inheritance">
			<parameter name="extends" value="empire_order" />
		</behavior>
		<column name="dest_id" type="integer" description="Source destination of order" />
		<foreign-key foreignTable="match_state" phpName="Dest" onDelete="CASCADE">
			<reference local="dest_id" foreign="state_id" />
		</foreign-key>
	</table>

	<table name="order_support" phpName="Support">
		<behavior name="concrete_inheritance">
			<parameter name="extends" value="empire_order" />
		</behavior>
		<column name="ally_id" type="integer" description="Ally that your are supporting" />
		<column name="dest_id" type="integer" description="Source destination of order" />
		<foreign-key foreignTable="empire" phpName="Ally" onDelete="CASCADE">
			<reference local="ally_id" foreign="empire_id" />
		</foreign-key>
		<foreign-key foreignTable="match_state" phpName="Dest" onDelete="CASCADE">
			<reference local="dest_id" foreign="state_id" />
		</foreign-key>
	</table>

	<table name="order_convoy" phpName="Convoy">
		<behavior name="concrete_inheritance">
			<parameter name="extends" value="empire_order" />
		</behavior>
		<column name="middle_id" type="integer" description="Territory to convoy through" />
		<column name="dest_id"   type="integer" description="Source destination of order" />
		<foreign-key foreignTable="match_state" phpName="Middle" onDelete="CASCADE">
			<reference local="middle_id" foreign="state_id" />
		</foreign-key>
		<foreign-key foreignTable="match_state" PhpName="Desta" onDelete="CASCADE">
			<reference local="dest_id" foreign="state_id" />
		</foreign-key>
	</table>

	<table name="order_hold" phpName="Hold">
		<behavior name="concrete_inheritance">
			<parameter name="extends" value="empire_order" />
		</behavior>
	</table>

	<table name="order_disband" phpName="Disband">
		<behavior name="concrete_inheritance">
			<parameter name="extends" value="empire_order" />
		</behavior>
	</table>

	<table name="territory_template">
		<column name="game_id" type="integer" />
		<column name="territory_id" type="integer" primaryKey="true" autoIncrement="true" />

		<column name="name" type="varchar" size="100" required="true" />

		<column name="type" type="enum" valueSet="land,water" default="land" />
		<column name="is_supply"  type="char" size="1" default="0" description="True (1) if this territory is a supply base" />

		<!-- Initial state -->
		<column name="initial_occupier_id" type="integer" description="Initial occupying empire" />
		<column name="initial_unit" type="enum" valueSet="army,fleet,none" description="Occupying unit.  Only none if occpupier_id is empty." />

		<foreign-key foreignTable="game" refPhpName="GameTerritory" onDelete="CASCADE">
			<reference local="game_id" foreign="game_id" />
		</foreign-key>
		<foreign-key foreignTable="empire" phpName="InitialOccupier" refPhpName="InitialOccupier" onDelete="CASCADE">
			<reference local="initial_occupier_id" foreign="empire_id" />
		</foreign-key>
	</table>

	<table name="match_state" phpName="State" description="Contains the match state for every turn">
		<column name="state_id"     type="integer" required="true" primaryKey="true" autoIncrement="true" description="Needed for ease referencing" />
		<column name="match_id"     type="integer" required="true" />
		<column name="turn_id"      type="integer" required="true" />
		<column name="territory_id" type="integer" required="true" />

		<column name="occupier_id" type="integer" description="Occupying empire" />
		<column name="unit" type="enum" valueSet="army,fleet,none" description="Occupying unit.  Only none if occpupier_id is empty." />

		<foreign-key foreignTable="game_match" onDelete="CASCADE">
			<reference local="match_id" foreign="match_id" />
		</foreign-key>
		<foreign-key foreignTable="turn" onDelete="CASCADE">
			<reference local="turn_id" foreign="turn_id" />
		</foreign-key>
		<foreign-key foreignTable="territory_template" phpName="Territory" refPhpName="Territory" onDelete="CASCADE">
			<reference local="territory_id" foreign="territory_id" />
		</foreign-key>
		<foreign-key foreignTable="empire" phpName="Occupier" refPhpName="Occupier" onDelete="CASCADE">
			<reference local="occupier_id" foreign="empire_id" />
		</foreign-key>
	</table>


	<table name="territory_map" isCrossRef="true" description="Contains the neighbour information for each territory.  One row for every connection.">
		<!-- Because of the two territories, this causes an off redeclare error -->
		<!-- <column name="game_id" type="integer" required="true" primaryKey="true" /> -->
		<!-- <foreign&#45;key foreignTable="game" onDelete="CASCADE"> -->
		<!-- 	<reference local="game_id" foreign="game_id" /> -->
		<!-- </foreign&#45;key> -->

		<column name="territory_a_id" type="integer" required="true" primaryKey="true" />
		<column name="territory_b_id" type="integer" required="true" primaryKey="true" />
		<foreign-key foreignTable="territory_template" phpName="SelfTerritory" onDelete="CASCADE">
			<reference local="territory_a_id" foreign="territory_id" />
		</foreign-key>
		<foreign-key foreignTable="territory_template" phpName="Neighbour" onDelete="CASCADE">
			<reference local="territory_b_id" foreign="territory_id" />
		</foreign-key>
	</table>

</database>

<!-- vim: ts=4 sw=4 noet :
     -->
